"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const request_forwarder_1 = require("./request-forwarder");
const socket_manager_1 = require("./socket-manager");
function proxy(fastifyInstance, event, context, binaryTypes) {
    return new Promise((resolve, reject) => {
        const promise = {
            resolve,
            reject,
        };
        const resolver = {
            succeed: (data) => {
                return promise.resolve(data);
            },
        };
        binaryTypes = binaryTypes ? binaryTypes.slice() : [];
        if (fastifyInstance.server.listening) {
            request_forwarder_1.RequestForwarder.forwardRequestToNodeServer(fastifyInstance.server, event, context, resolver, binaryTypes);
        }
        else {
            const socketSuffix = socket_manager_1.SocketManager.getSocketSuffix();
            startFastify(fastifyInstance, socketSuffix).on('listening', () => request_forwarder_1.RequestForwarder.forwardRequestToNodeServer(fastifyInstance.server, event, context, resolver, binaryTypes));
        }
    });
}
exports.proxy = proxy;
function startFastify(instance, socketSuffix) {
    instance.listen(socket_manager_1.SocketManager.getSocketPath(socketSuffix));
    return instance.server;
}
//# sourceMappingURL=index.js.map